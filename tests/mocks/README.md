# Tests Mocks

**Folder:** `tests/mocks/`
**Generated by:** `make mocks` (GoMock / `mockgen`)

## Responsibility

* Centralize **all** test doubles (mocks) for **output ports** used across unit tests.
* Avoid manual stubs/boilerplate.
* Keep mocks always in sync with the **real interfaces**.

> ⚠️ **Do not edit files here by hand.** They are overwritten. Always regenerate with `make mocks`.

---

## How it works

* Source interfaces are discovered under:

    * `internal/**/core/ports/output/*.go`
    * `internal/platform/ports/output/*.go`
* For each source, a mock is generated **flat** into `tests/mocks/` using the single package `mocks`.
* Files include the standard header: `// Code generated by MockGen. DO NOT EDIT.`
* **Duplicate basename guard:** in flat mode, if two sources share the same filename, generation fails with a friendly message. Use namespaced mode to avoid collisions.

---

## Common targets

```bash
# Generate all mocks (flat, default)
make mocks

# Namespaced filenames (avoids basename collisions)
make mocks NAMESPACE=1
# => e.g. user__core__ports__output__user_output_mock.go

# Generate only for a specific context (e.g. "user")
make mocks CONTEXT=user

# Inspect sources/targets that will be used
make mocks-list

# Clean all generated mocks
make clean_mocks
```

> Tip: the `verify` pipeline already runs mock generation, so `make verify` keeps mocks fresh locally.

---

## Conventions

* **Single package:** all files use `package mocks`.
* **Flat naming (default):** `<basename>_mock.go` (e.g., `user_output_mock.go`).
* **Namespaced naming (NAMESPACE=1):** `<path__with__double_underscores>_mock.go`.

---

## When to regenerate

* Any interface under `ports/output` was **added/removed/renamed**.
* Any method **signature changed**.
* After pulling changes that modify the ports.

---

## Requirements

* Go toolchain installed.
* `mockgen` available:

  ```bash
  go install github.com/golang/mock/mockgen@latest
  ```

  Or check with:

  ```bash
  make verify_mockgen
  ```
* Optional: install the whole dev toolchain:

  ```bash
  make tools-install
  ```

---

## Best practices

* **Never** commit manual edits to generated mocks — if you see diffs, run `make mocks`.
* In tests, prefer `gomock.AssignableToTypeOf(...)` for dynamic maps/structs and keep logger expectations **relaxed** where appropriate to reduce flakiness.

---

## TL;DR

1. Don’t edit `tests/mocks/*`.
2. Regenerate with `make mocks` (or `make verify`).
3. If filenames collide, run `make mocks NAMESPACE=1`.
