{"config":{"lang":["en"],"separator":"[\\s\\-]+","pipeline":["stopWordFilter"]},"docs":[{"location":"","title":"AionApi \u2014 Documentation","text":"<p>Welcome to the AionApi documentation \u2014 a concise reference and walkthrough for this modular Go backend that powers habit and diary management with REST and GraphQL APIs.</p>"},{"location":"#build-better-habits-with-data","title":"Build better habits with data","text":"<p>Aion helps you capture daily actions, measure patterns, and foster sustainable routines using a simple, extensible API-first platform. The server is designed for reliability, observability, and developer ergonomics \u2014 ideal for experimentation and iteration.</p> <p>Key ideas: - Instrumented by default (OpenTelemetry + Prometheus) so you can observe behavior and performance - Hexagonal (Ports &amp; Adapters) architecture that keeps business logic decoupled from transport and infrastructure - Developer-first workflows with codegen, generated mocks, formatters and linters</p>"},{"location":"#quick-links","title":"Quick links","text":"<ul> <li>Getting started \u2014 Quick setup and local developer workflow: <code>docs/getting-started.md</code></li> <li>Architecture \u2014 Design, component responsibilities and request flows: <code>docs/architecture.md</code></li> <li>Platform \u2014 Observability, server and configuration notes: <code>docs/platform.md</code></li> <li>API (Swagger) \u2014 interactive API explorer: https://lechitz.github.io/AionApi/swagger-ui/</li> <li>Raw OpenAPI spec: <code>./swagger/swagger.yaml</code></li> </ul>"},{"location":"#quick-start-dev","title":"Quick start (dev)","text":"<p>These commands get you from repo clone to a running dev environment.</p> <pre><code># clone\ngit clone git@github.com:lechitz/AionApi.git\ncd AionApi\n\n# install recommended developer tools (goimports, golines, golangci-lint, migrate, gqlgen, mockgen, ...)\nmake install-tools\n\n# fetch modules\ngo mod download\n\n# start the local development stack (Postgres, API, etc.)\nmake dev\n\n# apply migrations and optionally seed sample data\nexport MIGRATION_DB=\"postgres://aion:aion@localhost:5432/aionapi?sslmode=disable\"\nmake migrate-up\nmake seed-all\n\n# health check\ncurl -s http://localhost:8080/aion/health | jq\n</code></pre> <p>Note: <code>make install-tools</code> is a convenient alias for the repository tooling installer (<code>tools-install</code> in <code>makefiles/tooling.mk</code>).</p>"},{"location":"#explore-the-api","title":"Explore the API","text":"<ul> <li>Live interactive API (Swagger UI): https://lechitz.github.io/AionApi/swagger-ui/</li> <li>OpenAPI spec (raw): <code>https://raw.githubusercontent.com/lechitz/AionApi/main/swagger/swagger.yaml</code></li> </ul>"},{"location":"#preview-this-documentation-locally","title":"Preview this documentation locally","text":"<p>If you want to preview the MkDocs site while editing:</p> <pre><code># ensure mkdocs + mkdocs-material are installed in your environment\nmkdocs serve\n# open http://127.0.0.1:8000 in the browser\n</code></pre>"},{"location":"architecture/","title":"Architecture \u2014 AionApi","text":"<p>This document describes the architectural principles, component responsibilities, and runtime flows in AionApi. It is intended as a technical reference for maintainers and for guiding future extensions.</p> <p>Summary</p> <ul> <li>Hexagonal (Ports &amp; Adapters) architecture: core business logic is independent of transport and infrastructure.</li> <li>Primary adapters (HTTP / GraphQL) are thin; usecases contain business rules and orchestrations.</li> <li>Observability-first: OpenTelemetry tracing, Prometheus metrics, and Grafana dashboards.</li> <li>Consistent error model, standard response envelope, and strict use of context propagation.</li> </ul>"},{"location":"architecture/#high-level-layout","title":"High-level layout","text":"<p>Top-level layout (simplified):</p> <pre><code>AionApi/\n\u251c\u2500 cmd/                      # application entrypoints\n\u251c\u2500 internal/                 # bounded contexts and platform (bootstrap, server, config)\n\u2502  \u251c\u2500 &lt;bounded-context&gt;/     # auth, user, category, tag, habit, admin ...\n\u2502  \u2502  \u251c\u2500 core/               # business logic\n|  |  \u2502  \u251c\u2500 domain/          # entities, value objects\n\u2502  \u2502  \u2502  \u251c\u2500 ports/           # input/output interfaces\n\u2502  \u2502  \u2502  \u2514\u2500 usecase/         # application services\n\u2502  \u2502  \u251c\u2500 adapter/            # primary (http/graphql) + secondary (db/cache/token)\n\u2502  \u2514\u2500 platform/              # config, bootstrap, server, observability\n\u251c\u2500 infrastructure/           # docker, migrations, observability resources\n\u251c\u2500 docs/                     # MkDocs site\n\u251c\u2500 swagger/                  # OpenAPI artifacts\n\u2514\u2500 tests/                    # test helpers and generated mocks\n</code></pre> <p>Bounded contexts include <code>auth</code>, <code>user</code>, <code>category</code>, <code>tag</code>, <code>habit</code>, and <code>admin</code>. Each context defines its own domain model, ports, and adapters.</p>"},{"location":"architecture/#design-principles","title":"Design principles","text":"<ul> <li>Explicit contracts: the core defines input and output ports (interfaces) so implementations can vary without changing business code.</li> <li>Single responsibility: adapters are responsible only for translation and transport concerns; usecases handle business rules.</li> <li>Testability: core logic is pure Go and easy to unit-test with table-driven tests + mocks for ports.</li> <li>Observability: every handler, usecase and repository opens a span and adds structured attributes.</li> <li>Config-driven timeouts and limits: no hard-coded timeouts; read from configuration with safe defaults.</li> </ul>"},{"location":"architecture/#components-and-responsibilities","title":"Components and responsibilities","text":"<ul> <li>Core (Usecases)</li> <li>Located at <code>internal/&lt;ctx&gt;/core/usecase</code>.</li> <li> <p>Implement application flows, validations, and orchestrations. Return domain values or typed semantic errors.</p> </li> <li> <p>Primary adapters (HTTP / GraphQL)</p> </li> <li>Located at <code>internal/&lt;ctx&gt;/adapter/primary</code>.</li> <li> <p>Decode requests, validate DTOs, start traces/spans, call usecases, map domain \u2192 transport response.</p> </li> <li> <p>Secondary adapters (DB, Cache, Token, Logger)</p> </li> <li>Located at <code>internal/&lt;ctx&gt;/adapter/secondary</code>.</li> <li> <p>Implement output ports declared by the core. They keep infra-specific code isolated (GORM, redis client, external SDKs).</p> </li> <li> <p>Platform layer</p> </li> <li> <p><code>internal/platform</code> contains bootstrap wiring, server setup (HTTP / GraphQL), shared middleware, config loader, and observability wiring.</p> </li> <li> <p>Shared packages</p> </li> <li><code>internal/shared/*</code> holds shared helpers: <code>sharederrors</code>, <code>httpresponse</code>, <code>constants</code>, and test helpers.</li> </ul>"},{"location":"architecture/#request-lifecycle-detailed","title":"Request lifecycle (detailed)","text":""},{"location":"architecture/#rest-flow-example-update-password","title":"REST flow (example: Update password)","text":"<ol> <li>HTTP request arrives at handler (<code>adapter/primary/http</code>).</li> <li>Handler parses the request and validates the DTO.</li> <li>Handler starts a trace span and sets common attributes (route, method, user_id if available).</li> <li>Handler calls the usecase input port with <code>context.Context</code>.</li> <li>Usecase executes domain logic, calling output ports (repositories, caches, token provider).</li> <li>Output adapters perform context-aware IO (e.g. <code>db.WithContext(ctx)</code>) and map infra errors to semantic domain errors.</li> <li>Usecase returns domain values or a semantic error.</li> <li>Handler maps results to a standardized JSON envelope (<code>internal/shared/httpresponse</code>) and ends the span.</li> </ol>"},{"location":"architecture/#graphql-flow-example-create-category","title":"GraphQL flow (example: Create Category)","text":"<ul> <li>Resolver \u2192 GraphQL handler \u2192 DTO mapping \u2192 usecase \u2192 repository \u2192 domain mapping \u2192 resolver returns GraphQL model.</li> <li>GraphQL middleware should also start a top-level span and propagate context to resolvers.</li> </ul>"},{"location":"architecture/#error-model-and-http-mapping","title":"Error model and HTTP mapping","text":"<ul> <li>The repository uses typed semantic errors (validation, not_found, conflict, unauthorized, internal, etc.) defined in <code>internal/shared/sharederrors</code>.</li> <li>The adapter maps these semantic errors to HTTP status codes consistently:</li> <li>validation \u2192 400</li> <li>unauthorized \u2192 401</li> <li>forbidden \u2192 403</li> <li>not_found \u2192 404</li> <li>conflict \u2192 409</li> <li>internal \u2192 500</li> <li>All responses use a consistent envelope shape to simplify clients and monitoring.</li> </ul>"},{"location":"architecture/#persistence-and-migrations","title":"Persistence and migrations","text":"<ul> <li>Migrations are SQL files under <code>infrastructure/db/migrations</code> and applied with the <code>migrate</code> CLI via Make targets (<code>make migrate-up</code>).</li> <li>Repositories implement explicit mapping between DB models and domain models to keep the domain clean of ORM types.</li> <li>Repositories always use context-aware DB operations and return translated semantic errors.</li> <li>Soft deletes: the application ensures reads exclude logically deleted rows and updates return not-found when no rows were affected.</li> </ul>"},{"location":"architecture/#authentication-security","title":"Authentication &amp; security","text":"<ul> <li>Authentication usecase issues access and refresh tokens through an <code>AuthProvider</code> output port.</li> <li>Tokens may be stored / referenced in a cache (<code>AuthStore</code>) for revocation support.</li> <li>HTTP authentication middleware validates <code>Authorization: Bearer &lt;token&gt;</code> and populates context with <code>user_id</code> and claims.</li> <li>Secrets must never be logged (the logger and helpers ensure sensitive fields are redacted).</li> <li>Follow OWASP guidance for JWT usage, cookie flags and CORS policies.</li> </ul>"},{"location":"architecture/#observability","title":"Observability","text":"<ul> <li>Tracing: OpenTelemetry spans are created at the handler and propagated into usecases and repositories. Naming convention: <code>aionapi.&lt;context&gt;.&lt;component&gt;</code> (e.g. <code>aionapi.user.usecase</code>).</li> <li>Metrics: Prometheus instrumentation and scrape config live under <code>infrastructure/observability/prometheus</code>.</li> <li>Dashboards &amp; logs: Grafana dashboards and Fluent Bit/Loki configs are under <code>infrastructure/observability</code>.</li> </ul> <p>Suggested local env to enable OTLP export:</p> <pre><code>export OTEL_EXPORTER_OTLP_ENDPOINT=\"http://localhost:4318\"\nexport OTEL_SERVICE_NAME=\"AionApi\"\nexport OTEL_SERVICE_VERSION=\"0.1.0\"\n</code></pre>"},{"location":"architecture/#testing-strategy","title":"Testing strategy","text":"<ul> <li>Unit tests: focus on usecases; use gomock-generated mocks for output ports (<code>tests/mocks</code>), and helper suites in <code>tests/setup</code>.</li> <li>Integration tests: exercise adapters and real infra (run against Dockerized Postgres/Redis). Use a dedicated test DB and cleanup strategy.</li> <li>End-to-end / smoke tests: run against the full <code>make dev</code> stack and validate common flows (health, login, create user, basic GraphQL ops).</li> <li>Coverage: <code>make test-cover</code> produces coverage artifacts in <code>tests/coverage/</code>.</li> </ul>"},{"location":"architecture/#code-generation-developer-tooling","title":"Code generation &amp; developer tooling","text":"<ul> <li>GraphQL: schema fragments live in contexts; <code>make graphql</code> collects them and runs <code>gqlgen</code>.</li> <li>Mocks: <code>make mocks</code> runs <code>mockgen</code> and stores generated mocks under <code>tests/mocks</code>.</li> <li>Quality: <code>make lint</code>, <code>make lint-fix</code>, <code>make format</code> and <code>golangci-lint</code> configuration are part of the developer workflow.</li> </ul>"},{"location":"architecture/#adding-a-new-bounded-context-checklist","title":"Adding a new bounded context \u2014 checklist","text":"<ol> <li>Create <code>internal/&lt;ctx&gt;/core/domain</code> for entities and value objects.</li> <li>Define input/output ports under <code>internal/&lt;ctx&gt;/core/ports</code>.</li> <li>Implement usecases in <code>internal/&lt;ctx&gt;/core/usecase</code>.</li> <li>Add primary adapters (<code>adapter/primary/http</code> and/or <code>graphql</code>) for transport.</li> <li>Add secondary adapters (<code>adapter/secondary/db</code>, <code>cache</code>, <code>token</code>) implementing the output ports.</li> <li>Wire concrete adapters in <code>internal/platform/bootstrap</code>.</li> <li>Mount routes in <code>internal/platform/server/http/composer.go</code>.</li> <li>Add tests and generate mocks (<code>make mocks</code>).</li> <li>Document the context in <code>docs/</code> and update <code>mkdocs.yml</code> nav if needed.</li> </ol>"},{"location":"architecture/#deployment-and-operational-notes","title":"Deployment and operational notes","text":"<ul> <li>Use environment-specific config files for production vs staging vs local development.  </li> <li>Keep secrets in a secure vault or secrets manager (do not commit to repo).  </li> <li>CI jobs should run <code>make lint</code>, <code>make test</code>, and <code>make docs.gen</code> (if docs changes are present).  </li> <li>Consider blue/green or rolling deployment patterns for production services.</li> </ul>"},{"location":"architecture/#diagram-mermaid","title":"Diagram (Mermaid)","text":"<p>You can embed a Mermaid diagram into MkDocs (if plugin enabled). Example:</p> <pre><code>flowchart LR\n  Client --&gt;|HTTP/GraphQL| Handler[Handler (primary adapter)]\n  Handler --&gt;|calls| Usecase[Usecase (core)]\n  Usecase --&gt; Repo[Repository (secondary adapter)]\n  Usecase --&gt; AuthProvider[AuthProvider (secondary)]\n  Repo --&gt; DB[(Postgres)]\n  AuthProvider --&gt; Cache[(Redis)]\n</code></pre>"},{"location":"architecture/#conventions-style","title":"Conventions &amp; style","text":"<ul> <li>Always propagate <code>context.Context</code> and honor cancellations and deadlines.  </li> <li>Keep handlers thin: validation, tracing, DTO mapping, usecase invocation, response mapping.  </li> <li>Keep usecases pure from infra concerns; use small interfaces for side effects.  </li> <li>Avoid magic strings \u2014 centralize keys in <code>internal/shared/constants</code>.</li> </ul>"},{"location":"getting-started/","title":"Getting Started","text":"<p>Welcome to AionApi. This page takes you from zero to a working local environment with Docker, the database migrated, tests passing, and a few REST/GraphQL calls verified.</p>"},{"location":"getting-started/#tldr-fast-path","title":"TL;DR (fast path)","text":"<pre><code># 1) Clone and enter the project\ngit clone https://github.com/lechitz/AionApi.git\ncd AionApi\n\n# 2) (Optional, recommended) install local dev tools\nmake tools-install\n\n# 3) Bring up the DEV stack (Docker + Postgres)\nmake dev\n\n# 4) Apply database migrations\nexport MIGRATE_BIN=\"$(go env GOPATH)/bin/migrate\"\nexport MIGRATION_DB=\"postgres://aion:aion@localhost:5432/aionapi?sslmode=disable\"\nexport MIGRATION_PATH=\"infrastructure/db/migrations\"\nmake migrate-up\n\n# 5) (Optional) Seed sample data\nmake seed-all\n\n# 6) Health check\ncurl -s http://localhost:8080/aion/health | jq\n</code></pre> <p>If things are ok, you should see a JSON payload containing the service name/version/environment.</p>"},{"location":"getting-started/#prerequisites","title":"Prerequisites","text":"<ul> <li>Go 1.24+</li> <li>Docker and Docker Compose (v2)</li> <li>make (GNU Make)</li> <li>(Optional) jq to pretty-print JSON on the CLI</li> </ul> <p>If you prefer not to install Go on your host (using only Docker), you still need the <code>migrate</code> CLI to run DB migrations via Make. Use <code>make tools-install</code> to install all expected tools under your <code>GOPATH/bin</code>.</p>"},{"location":"getting-started/#repository-layout-essentials","title":"Repository layout (essentials)","text":"<pre><code>AionApi/\n\u251c\u2500 infrastructure/\n\u2502  \u251c\u2500 db/\n\u2502  \u2502  \u251c\u2500 migrations/         # *.sql (schema &amp; changesets)\n\u2502  \u2502  \u2514\u2500 seed/               # sample data\n\u2502  \u2514\u2500 docker/\n\u2502     \u251c\u2500 Dockerfile          # app build\n\u2502     \u2514\u2500 environments/\n\u2502        \u2514\u2500 dev/docker-compose-dev.yaml\n\u251c\u2500 internal/                 # domain, ports &amp; adapters (HTTP/GraphQL/DB/etc.)\n\u251c\u2500 makefiles/                # grouped Make targets (migrate, docker, test, etc.)\n\u251c\u2500 Makefile                  # includes makefiles/*\n\u2514\u2500 README.md\n</code></pre>"},{"location":"getting-started/#environment-configuration","title":"Environment configuration","text":"<p>For local development, <code>docker-compose-dev.yaml</code> already provides sensible defaults (Postgres on <code>localhost:5432</code>, API on <code>localhost:8080</code>). If you need to customize values, create a <code>.env.dev</code> (optional):</p> <pre><code># illustrative example \u2014 adjust to your needs\ncp infrastructure/docker/environments/example/.env.example infrastructure/docker/environments/dev/.env.dev\n# edit infrastructure/docker/environments/dev/.env.dev\n</code></pre> <p>If you skip <code>.env.dev</code>, the compose defaults are enough to boot the stack.</p>"},{"location":"getting-started/#bring-up-the-dev-stack","title":"Bring up the DEV stack","text":"<pre><code>make dev       # (= image build + docker compose up)\n# or, if you built recently:\nmake dev-up\n# to stop and remove volumes for this stack:\nmake dev-down\n</code></pre> <p>Expected services:</p> <ul> <li>Postgres: <code>localhost:5432</code> (db <code>aionapi</code>, user <code>aion</code>, pass <code>aion</code>)</li> <li>API: <code>localhost:8080</code> (REST base prefix: <code>/aion-api</code>, GraphQL: <code>/graphql</code>)</li> </ul> <p>Health check:</p> <pre><code>curl -s http://localhost:8080/aion/health | jq\n</code></pre>"},{"location":"getting-started/#database-migrations-seeds","title":"Database: migrations &amp; seeds","text":""},{"location":"getting-started/#install-migrate-once","title":"Install <code>migrate</code> (once)","text":"<pre><code>make tools-install\n# ensures: migrate, golangci-lint, gqlgen, etc. in your $GOPATH/bin\n</code></pre>"},{"location":"getting-started/#environment-variables-expected-by-migration-targets","title":"Environment variables expected by migration targets","text":"<pre><code>export MIGRATE_BIN=\"$(go env GOPATH)/bin/migrate\"\nexport MIGRATION_DB=\"postgres://aion:aion@localhost:5432/aionapi?sslmode=disable\"\nexport MIGRATION_PATH=\"infrastructure/db/migrations\"\n</code></pre>"},{"location":"getting-started/#applyrollback-migrations","title":"Apply/rollback migrations","text":"<pre><code>make migrate-up        # apply all \"up\" migrations\nmake migrate-down      # rollback one step\n# advanced usage:\nmake migrate-force VERSION=20250101010101  # force version (\u26a0\ufe0f beware)\n</code></pre>"},{"location":"getting-started/#seeds","title":"Seeds","text":"<pre><code># executes SQL seed scripts inside the DEV Postgres container\nmake seed-users\nmake seed-categories\nmake seed-all\n</code></pre>"},{"location":"getting-started/#tests-coverage-code-quality","title":"Tests, coverage &amp; code quality","text":"<pre><code>make test           # unit tests with -race\nmake test-cover     # coverage + HTML at tests/coverage/coverage.html\nmake test-html-report\nmake format         # goimports + golines (gofumpt)\nmake lint           # golangci-lint\nmake lint-fix       # attempt autofix\nmake verify         # local pipeline: graphql \u2192 mocks \u2192 lint \u2192 test \u2192 coverage\n</code></pre> <p>Open the coverage report in your browser:</p> <pre><code>tests/coverage/coverage.html\n</code></pre>"},{"location":"getting-started/#codegen-graphql-mocks","title":"Codegen (GraphQL &amp; Mocks)","text":"<p>These targets keep generated artifacts in sync with the source code.</p> <pre><code># (re)generate GraphQL types/resolvers from *.graphqls\nmake graphql\n\n# generate mocks (GoMock) for output-port interfaces (saved in tests/mocks/)\nmake mocks\n# namespaced filenames to avoid basename collisions:\nmake mocks NAMESPACE=1\n# generate only for a specific context:\nmake mocks CONTEXT=user\n</code></pre>"},{"location":"getting-started/#using-the-api-rest","title":"Using the API (REST)","text":"<p>REST base prefix: <code>/aion-api</code></p>"},{"location":"getting-started/#create-user","title":"Create user","text":"<pre><code>curl -X POST http://localhost:8080/aion-api/v1/users/create \\\n  -H 'Content-Type: application/json' \\\n  -d '{\n    \"username\": \"alice\",\n    \"email\": \"alice@example.com\",\n    \"password\": \"s3cret\"\n  }'\n</code></pre>"},{"location":"getting-started/#login-obtain-token","title":"Login (obtain token)","text":"<pre><code>TOKEN=$(curl -s -X POST http://localhost:8080/aion-api/v1/auth/login \\\n  -H 'Content-Type: application/json' \\\n  -d '{\"username\":\"alice\",\"password\":\"s3cret\"}' | jq -r '.token')\necho \"$TOKEN\"\n</code></pre>"},{"location":"getting-started/#list-users-protected-route","title":"List users (protected route)","text":"<pre><code>curl -H \"Authorization: Bearer $TOKEN\" \\\n  http://localhost:8080/aion-api/v1/users/all | jq\n</code></pre> <p>Other useful routes: <code>GET /aion-api/v1/users/{user_id}</code> <code>PUT /aion-api/v1/users/</code> (update self) <code>PUT /aion-api/v1/users/password</code> <code>DELETE /aion-api/v1/users/</code></p>"},{"location":"getting-started/#using-the-api-graphql","title":"Using the API (GraphQL)","text":"<ul> <li>Endpoint: <code>http://localhost:8080/graphql</code></li> </ul> <p>List categories (query):</p> <pre><code>curl -s http://localhost:8080/graphql \\\n  -H 'Content-Type: application/json' \\\n  -d '{\"query\":\"query { listAllCategories { id name colorHex } }\"}' | jq\n</code></pre> <p>Create category (mutation):</p> <pre><code>curl -s http://localhost:8080/graphql \\\n  -H 'Content-Type: application/json' \\\n  -d '{\"query\":\"mutation { createCategory(input:{name:\\\"Work\\\", colorHex:\\\"#3366FF\\\"}) { id name colorHex } }\"}' | jq\n</code></pre> <p>If your instance requires auth for GraphQL, include <code>Authorization: Bearer $TOKEN</code> in the headers.</p>"},{"location":"getting-started/#observability-optional-in-dev","title":"Observability (optional in DEV)","text":"<p>The platform is wired for OpenTelemetry (traces/metrics). To export to a local Collector, configure environment variables like:</p> <pre><code>export OTEL_EXPORTER_OTLP_ENDPOINT=\"http://localhost:4318\"\nexport OTEL_SERVICE_NAME=\"AionApi\"\nexport OTEL_SERVICE_VERSION=\"0.1.0\"\n</code></pre> <p>Useful files:</p> <ul> <li><code>infrastructure/observability/otel/otel-collector-config.yaml</code></li> <li><code>infrastructure/observability/grafana/</code> (dashboards)</li> <li><code>infrastructure/observability/prometheus/prometheus.yml</code></li> </ul> <p>You can extend your local stack to include these services via Docker Compose, as needed.</p>"},{"location":"getting-started/#tips-troubleshooting","title":"Tips &amp; Troubleshooting","text":"<ul> <li> <p><code>migrate: command not found</code>   Run <code>make tools-install</code> and ensure <code>$(go env GOPATH)/bin</code> is in your <code>PATH</code>.</p> </li> <li> <p>Cannot connect to Postgres   Check running containers with <code>docker ps</code>, free port <code>5432</code>, and the DSN in <code>MIGRATION_DB</code>.</p> </li> <li> <p>Port 8080 is already in use   Stop the service occupying it or change the HTTP port via env vars and restart.</p> </li> <li> <p>401 on protected routes   Verify the <code>Authorization: Bearer &lt;TOKEN&gt;</code> header is present and the token is valid.</p> </li> <li> <p>Unexpected 404/405   Remember the REST base prefix <code>/aion-api</code>.</p> </li> </ul>"},{"location":"getting-started/#whats-next","title":"What\u2019s next","text":"<ul> <li>Architecture: high-level view (Ports &amp; Adapters), conventions, and boundaries.</li> <li>Platform: Config, Router (port + chi), Observability.</li> <li>API Reference: details for each REST route and GraphQL operation.</li> </ul> <p>These pages will be published in the next sections of the documentation.</p>"},{"location":"platform/","title":"Platform","text":"<p>This page describes the cross\u2011cutting platform layer that powers AionApi: configuration, dependency bootstrap, HTTP/GraphQL servers, middlewares, observability, and Docker environments. If you\u2019re wiring a new context (feature) or deploying locally, start here.</p> <p>TL;DR</p> <ul> <li>Typed Config from env vars, with sane defaults and validation</li> <li>Central Bootstrap that wires DB, cache, token, hasher, logger</li> <li>Framework\u2011agnostic Router Port + chi adapter</li> <li>First\u2011class Observability (OpenTelemetry traces/metrics, Prometheus, Grafana)</li> <li>Clear separation of concerns: platform vs. domain</li> </ul>"},{"location":"platform/#1-directory-map-platform-layer","title":"1) Directory map (platform layer)","text":"<pre><code>internal/platform/\n  bootstrap/         # build infra adapters + services, return AppDependencies + cleanup\n  config/            # env \u2192 typed config + validation/normalization\n  server/\n    http/            # router port, chi adapter, generic handlers, middlewares, composer\n    graph/           # GraphQL wiring (schema assembly via make graphql)\n  observability/     # OTel tracer/meter setup (OTLP/HTTP), helpers\n</code></pre> <p>Complementary infra lives under <code>infrastructure/</code> (Docker, migrations, OTEL, Prometheus, Grafana, Loki/Fluent Bit).</p>"},{"location":"platform/#2-configuration","title":"2) Configuration","text":"<p>The <code>config</code> package loads environment variables into a typed struct, validates values, and normalizes things like the HTTP context path.</p>"},{"location":"platform/#21-quick-example-env","title":"2.1 Quick example (env)","text":"<pre><code># General\nAPP_NAME=AionApi\nAPP_ENV=development\nAPP_VERSION=0.1.0\n\n# HTTP\nSERVER_HTTP_CONTEXT=/aion-api\nSERVER_HTTP_PORT=8080\nSHUTDOWN_TIMEOUT=5s\n\n# GraphQL\nGRAPHQL_PATH=/graphql\nGRAPHQL_TIMEOUT=5s\nGRAPHQL_PLAYGROUND=true\n\n# Database\nDB_HOST=localhost\nDB_PORT=5432\nDB_USER=aion\nDB_PASSWORD=secret\nDB_NAME=aionapi\nDB_SSLMODE=disable\nDB_MAX_OPEN_CONNS=25\nDB_MAX_IDLE_CONNS=25\nDB_CONN_MAX_LIFETIME=30m\n\n# Cache (Redis)\nCACHE_ADDR=localhost:6379\nCACHE_DB=0\nCACHE_PASSWORD=\n\n# Secrets\nSECRET_KEY=super-long-random-hex\n\n# Observability (OTLP over HTTP)\nOTEL_EXPORTER_OTLP_ENDPOINT=http://localhost:4318\nOTEL_SERVICE_NAME=AionApi\nOTEL_SERVICE_VERSION=0.1.0\nOTEL_EXPORTER_OTLP_HEADERS=x-api-key=dev\nOTEL_INSECURE=true\n</code></pre> <p>Tip</p> <p>In dev, if <code>SECRET_KEY</code> is missing, the loader may generate a temporary key and log a warning. Always set a real key in production.</p>"},{"location":"platform/#22-guarantees","title":"2.2 Guarantees","text":"<ul> <li>Minimal timeouts are enforced (HTTP/GraphQL) to avoid foot\u2011guns.</li> <li><code>SERVER_HTTP_CONTEXT</code> is normalized to <code>\"/prefix\"</code> with no trailing slash.</li> <li>Config contains only platform\u2011level concerns; domain code receives values already parsed and validated.</li> </ul>"},{"location":"platform/#3-bootstrap-composition-root","title":"3) Bootstrap (composition root)","text":"<p>The <code>bootstrap</code> package constructs infrastructure adapters and wires usecases (services) through domain ports.</p> <p>Responsibilities:</p> <ol> <li>Build secondary adapters: Postgres (GORM), Redis, token provider (e.g., JWT), password hasher (bcrypt/argon2), context logger (Zap), etc.</li> <li>Instantiate repositories and stores.</li> <li>Construct usecase services (Auth, User, Category, Tag, Admin) via input ports.</li> <li>Return <code>*AppDependencies</code> and a <code>cleanup(ctx)</code> function to gracefully close DB/cache.</li> </ol> <p>Pseudocode:</p> <pre><code>// InitializeDependencies(ctx, cfg, log) (*AppDependencies, cleanup, error)\n// - Connect DB (GORM) + Redis\n// - New token provider + hasher + logger\n// - New repositories/stores\n// - New usecase services\n// - return deps + cleanup\n</code></pre> <p>Note</p> <p>The bootstrap does not mount HTTP routes or start servers. It only builds dependencies.</p>"},{"location":"platform/#4-http-server","title":"4) HTTP Server","text":"<p>The HTTP layer is framework\u2011agnostic thanks to a Router Port. The default implementation uses chi.</p> <pre><code>internal/platform/server/http/\n  ports/                  # Router interface (framework\u2011agnostic)\n  router/chi/             # chi adapter implementing the port\n  generic/                # health, error/404/405 handlers\n  middleware/\n    requestid/            # ensures X-Request-ID\n    recovery/             # catches panics, returns uniform 500\n  composer.go             # wires routes, middlewares, defaults\n  server.go               # *http.Server startup/shutdown\n</code></pre>"},{"location":"platform/#41-router-port-contract","title":"4.1 Router Port (contract)","text":"<pre><code>type Middleware func(http.Handler) http.Handler\n\ntype Router interface {\n  Use(mw ...Middleware)\n  Group(prefix string, fn func(Router))\n  GroupWith(mw Middleware, fn func(Router))\n  Mount(prefix string, h http.Handler)\n  GET/POST/PUT/DELETE(path string, h http.Handler)\n  SetNotFound(h http.Handler)\n  SetMethodNotAllowed(h http.Handler)\n  SetError(func(http.ResponseWriter, *http.Request, error))\n  ServeHTTP(http.ResponseWriter, *http.Request)\n}\n</code></pre>"},{"location":"platform/#42-composition-excerpt","title":"4.2 Composition (excerpt)","text":"<pre><code>r := chiadapter.New()\n\n// Global middlewares (order matters)\nr.Use(recovery.New(genericHandler)) // outermost guard\nr.Use(requestid.New())              // ensure X-Request-ID\n\n// Platform defaults\nr.SetNotFound(http.HandlerFunc(genericHandler.NotFoundHandler))\nr.SetMethodNotAllowed(http.HandlerFunc(genericHandler.MethodNotAllowedHandler))\nr.SetError(genericHandler.ErrorHandler)\n\n// Context routes (examples)\nuserhandler.RegisterHTTP(r, userH)\nuserhandler.RegisterHTTPProtected(r, userH, authMiddleware)\n\n// GraphQL\nr.Mount(cfg.ServerGraphql.Path, graphqlHTTPHandler)\n</code></pre> <p>Warning</p> <p>Middleware order matters: keep recovery first so it can catch panics from everything else. <code>requestid</code> should run early to propagate the same ID through logs and traces.</p>"},{"location":"platform/#43-generic-endpoints","title":"4.3 Generic endpoints","text":"<ul> <li><code>GET /health</code> \u2014 returns service metadata.</li> <li>404/405 \u2014 standardized JSON bodies.</li> <li>Error/Recovery \u2014 uniform 500 via centralized error handler.</li> </ul>"},{"location":"platform/#44-error-response-shape","title":"4.4 Error &amp; response shape","text":"<p>Adapters use <code>internal/shared/httpresponse</code> + <code>sharederrors</code> to produce a consistent envelope and status mapping:</p> Domain error HTTP status validation 400 unauthorized 401 forbidden 403 not_found 404 conflict 409 rate_limited 429 internal (default) 500"},{"location":"platform/#5-graphql-server","title":"5) GraphQL Server","text":"<p>GraphQL lives alongside HTTP and is mounted under <code>GRAPHQL_PATH</code> (default <code>/graphql</code>). Schema is modular per context.</p> <p>Flow:</p> <ol> <li>Drop <code>*.graphqls</code> files under each context (<code>internal/&lt;ctx&gt;/adapter/primary/graphql/schema</code>).</li> <li>Run <code>make graphql</code> to copy modules into the platform graph package and execute gqlgen.</li> <li>Resolvers delegate to context handlers, which call usecases.</li> </ol> <pre><code>internal/platform/server/graph/schema/_modules/   # assembled by make graphql\n</code></pre> <p>Tip</p> <p>Keep business rules in usecases; GraphQL handlers are thin mappers with tracing.</p>"},{"location":"platform/#6-observability","title":"6) Observability","text":"<p>AionApi is tracing\u2011first. Traces and metrics are exported via OTLP/HTTP to an OpenTelemetry Collector.</p>"},{"location":"platform/#61-tracing","title":"6.1 Tracing","text":"<ul> <li> <p>Tracer names by layer, e.g.:</p> <ul> <li><code>aionapi.user.handler.http</code></li> <li><code>aionapi.user.usecase</code></li> <li><code>aionapi.user.repository</code></li> <li><code>aionapi.graphql.handler</code></li> <li>Each operation starts a span and sets canonical attributes (operation, ids, status). Errors call <code>span.RecordError(err)</code> and set error status.</li> </ul> </li> </ul>"},{"location":"platform/#62-metrics","title":"6.2 Metrics","text":"<ul> <li>Prometheus scraping configured in <code>infrastructure/observability/prometheus/prometheus.yml</code>.</li> <li>Grafana provisioning + example dashboard under <code>infrastructure/observability/grafana/</code>.</li> </ul>"},{"location":"platform/#63-collector-config-dev","title":"6.3 Collector config (dev)","text":"<ul> <li>Default endpoint: <code>OTEL_EXPORTER_OTLP_ENDPOINT=http://localhost:4318</code></li> <li>Optional headers via CSV: <code>OTEL_EXPORTER_OTLP_HEADERS=\"x-api-key=dev\"</code></li> <li>Set <code>OTEL_INSECURE=true</code> for plain HTTP in local setups.</li> </ul> <p>Note</p> <p>Logs are structured (Zap). Fluent Bit + Loki are optional and can be added later for log aggregation.</p>"},{"location":"platform/#7-docker-environments","title":"7) Docker &amp; environments","text":"<p>Docker Compose files live in <code>infrastructure/docker/</code> (dev and prod\u2011like). Use the <code>Makefile</code> targets for convenience.</p> <p>Common targets:</p> <pre><code>make dev-up      # start dev stack (API + DB + dependencies)\nmake dev-down    # stop &amp; remove dev stack\nmake dev         # build image + dev-up\nmake prod        # build and run prod-like stack (where applicable)\n</code></pre> <p>Environment files are kept under <code>infrastructure/docker/environments/</code>. Review and align them with the Config variables above.</p>"},{"location":"platform/#8-security-httpauth","title":"8) Security (HTTP/Auth)","text":"<ul> <li><code>Authorization: Bearer &lt;token&gt;</code> is validated by the auth middleware (primary adapter). On success, it injects <code>user_id</code> into <code>context</code> for downstream handlers.</li> <li>Cookie helpers (<code>internal/platform/server/http/helpers/httpresponse</code>) centralize secure cookie settings when a browser flow is used.</li> <li>Never log secrets: passwords, raw tokens, or cookie contents.</li> </ul>"},{"location":"platform/#9-adding-a-new-context-platform-checklist","title":"9) Adding a new context (platform checklist)","text":"<ol> <li>Ports &amp; Usecase: define input/output ports and implement usecase under <code>internal/&lt;ctx&gt;/core</code>.</li> <li> <p>Adapters:</p> <ul> <li>Primary: HTTP and/or GraphQL handler + DTO/schema</li> <li>Secondary: repository (DB), cache, external clients</li> <li>Bootstrap: wire repositories + services in <code>internal/platform/bootstrap</code>.</li> <li>HTTP composer: mount routes via <code>RegisterHTTP(...)</code> and protected routes via <code>RegisterHTTPProtected(...)</code>.</li> <li>GraphQL: add <code>schema/&lt;ctx&gt;.graphqls</code>, run <code>make graphql</code>.</li> <li>Docs: add <code>docs/&lt;ctx&gt;.md</code> and update <code>mkdocs.yml</code> navigation.</li> </ul> </li> </ol>"},{"location":"platform/#10-troubleshooting","title":"10) Troubleshooting","text":"<p>No traces/metrics show up</p> <ul> <li>Check <code>OTEL_EXPORTER_OTLP_ENDPOINT</code> and that the Collector is listening on <code>/v1/traces</code> <code>/v1/metrics</code> over HTTP.</li> <li>If using custom headers, confirm <code>OTEL_EXPORTER_OTLP_HEADERS</code> CSV is valid.</li> </ul> <p>Chi routes return 404</p> <ul> <li>Ensure the global HTTP context prefix is correct (<code>SERVER_HTTP_CONTEXT</code>, e.g., <code>/aion-api</code>). All routes are mounted beneath it.</li> </ul> <p>JWT accepted but user not authorized</p> <ul> <li>Verify the auth middleware is applied to the subtree via <code>GroupWith(middleware.Auth, ...)</code>.</li> <li>Confirm token cache (AuthStore) contains the same reference stored at login.</li> </ul> <p>Migrations don\u2019t run</p> <ul> <li>Export <code>MIGRATION_DB</code> DSN and <code>MIGRATION_PATH</code> environment variables used by the <code>make migrate-*</code> targets.</li> </ul> <p>GraphQL schema changes not reflected</p> <ul> <li>Run <code>make graphql</code> and then <code>go mod tidy</code>. Rebuild the service.</li> </ul>"},{"location":"platform/#11-further-reading","title":"11) Further reading","text":"<ul> <li><code>docs/architecture.md</code> \u2014 big picture of Hexagonal + request flows</li> <li><code>docs/getting-started.md</code> \u2014 local setup, make targets, common commands</li> <li>Source readmes under <code>internal/platform/*</code> for deep dives into each package</li> </ul>"}]}